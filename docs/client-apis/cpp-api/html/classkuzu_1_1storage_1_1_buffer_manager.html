<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Kuzu: kuzu::storage::BufferManager Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="kuzu-logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Kuzu
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><b>kuzu</b></li><li class="navelem"><b>storage</b></li><li class="navelem"><a class="el" href="classkuzu_1_1storage_1_1_buffer_manager.html">BufferManager</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="classkuzu_1_1storage_1_1_buffer_manager-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">kuzu::storage::BufferManager Class Reference</div></div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="buffer__manager_8h_source.html">buffer_manager.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a262253d11dd634cf624b2c301383955a"><td class="memItemLeft" align="right" valign="top"><a id="a262253d11dd634cf624b2c301383955a" name="a262253d11dd634cf624b2c301383955a"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>BufferManager</b> (uint64_t maxSizeForDefaultPagePool=common::StorageConfig::DEFAULT_BUFFER_POOL_SIZE *common::StorageConfig::DEFAULT_PAGES_BUFFER_RATIO, uint64_t maxSizeForLargePagePool=common::StorageConfig::DEFAULT_BUFFER_POOL_SIZE *common::StorageConfig::LARGE_PAGES_BUFFER_RATIO)</td></tr>
<tr class="separator:a262253d11dd634cf624b2c301383955a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a18156bd8ac6bfe642d61377fd8614524"><td class="memItemLeft" align="right" valign="top"><a id="a18156bd8ac6bfe642d61377fd8614524" name="a18156bd8ac6bfe642d61377fd8614524"></a>
uint8_t *&#160;</td><td class="memItemRight" valign="bottom"><b>pin</b> (<a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a> &amp;fileHandle, common::page_idx_t pageIdx)</td></tr>
<tr class="separator:a18156bd8ac6bfe642d61377fd8614524"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9fd3c20d9ea8b2182bd1373e86fdb3be"><td class="memItemLeft" align="right" valign="top"><a id="a9fd3c20d9ea8b2182bd1373e86fdb3be" name="a9fd3c20d9ea8b2182bd1373e86fdb3be"></a>
uint8_t *&#160;</td><td class="memItemRight" valign="bottom"><b>pinWithoutReadingFromFile</b> (<a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a> &amp;fileHandle, common::page_idx_t pageIdx)</td></tr>
<tr class="separator:a9fd3c20d9ea8b2182bd1373e86fdb3be"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9286aa957162a78486f97c3dcde67e1f"><td class="memItemLeft" align="right" valign="top"><a id="a9286aa957162a78486f97c3dcde67e1f" name="a9286aa957162a78486f97c3dcde67e1f"></a>
uint8_t *&#160;</td><td class="memItemRight" valign="bottom"><b>pinWithoutAcquiringPageLock</b> (<a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a> &amp;fileHandle, common::page_idx_t pageIdx, bool doNotReadFromFile)</td></tr>
<tr class="separator:a9286aa957162a78486f97c3dcde67e1f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac1351e18ab23443b3be000f975ad844d"><td class="memItemLeft" align="right" valign="top"><a id="ac1351e18ab23443b3be000f975ad844d" name="ac1351e18ab23443b3be000f975ad844d"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>setPinnedPageDirty</b> (<a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a> &amp;fileHandle, common::page_idx_t pageIdx)</td></tr>
<tr class="separator:ac1351e18ab23443b3be000f975ad844d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7b831ed29a16fae489acf33ad0a58266"><td class="memItemLeft" align="right" valign="top"><a id="a7b831ed29a16fae489acf33ad0a58266" name="a7b831ed29a16fae489acf33ad0a58266"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>unpin</b> (<a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a> &amp;fileHandle, common::page_idx_t pageIdx)</td></tr>
<tr class="separator:a7b831ed29a16fae489acf33ad0a58266"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6483c7a860173e9702be972b8410822c"><td class="memItemLeft" align="right" valign="top"><a id="a6483c7a860173e9702be972b8410822c" name="a6483c7a860173e9702be972b8410822c"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>unpinWithoutAcquiringPageLock</b> (<a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a> &amp;fileHandle, common::page_idx_t pageIdx)</td></tr>
<tr class="separator:a6483c7a860173e9702be972b8410822c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af6ae0ef3ad7a33d0651233ea9bf8154e"><td class="memItemLeft" align="right" valign="top"><a id="af6ae0ef3ad7a33d0651233ea9bf8154e" name="af6ae0ef3ad7a33d0651233ea9bf8154e"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>resize</b> (uint64_t newSizeForDefaultPagePool, uint64_t newSizeForLargePagePool)</td></tr>
<tr class="separator:af6ae0ef3ad7a33d0651233ea9bf8154e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac7bad0865c9ac30a9c6981f3140b1d81"><td class="memItemLeft" align="right" valign="top"><a id="ac7bad0865c9ac30a9c6981f3140b1d81" name="ac7bad0865c9ac30a9c6981f3140b1d81"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>removeFilePagesFromFrames</b> (<a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a> &amp;fileHandle)</td></tr>
<tr class="separator:ac7bad0865c9ac30a9c6981f3140b1d81"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a65268b09330a3ee0ae7f494ece93c2ee"><td class="memItemLeft" align="right" valign="top"><a id="a65268b09330a3ee0ae7f494ece93c2ee" name="a65268b09330a3ee0ae7f494ece93c2ee"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>flushAllDirtyPagesInFrames</b> (<a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a> &amp;fileHandle)</td></tr>
<tr class="separator:a65268b09330a3ee0ae7f494ece93c2ee"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2ca79326a7e3e515b03eaffd48507a0b"><td class="memItemLeft" align="right" valign="top"><a id="a2ca79326a7e3e515b03eaffd48507a0b" name="a2ca79326a7e3e515b03eaffd48507a0b"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>updateFrameIfPageIsInFrameWithoutPageOrFrameLock</b> (<a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a> &amp;fileHandle, uint8_t *newPage, common::page_idx_t pageIdx)</td></tr>
<tr class="separator:a2ca79326a7e3e515b03eaffd48507a0b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a592b2be2c400b01326ac11eccc2bdc8a"><td class="memItemLeft" align="right" valign="top"><a id="a592b2be2c400b01326ac11eccc2bdc8a" name="a592b2be2c400b01326ac11eccc2bdc8a"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>removePageFromFrameIfNecessary</b> (<a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a> &amp;fileHandle, common::page_idx_t pageIdx)</td></tr>
<tr class="separator:a592b2be2c400b01326ac11eccc2bdc8a"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>The Buffer Manager (BM) is the cache of database file pages. It provides the high-level functionality of pin() and unpin() the pages of the database files used by the Column/Lists in the storage layer, and operates via their FileHandles to make the page data available in one of the frames. BM can also be used by any operator or other components of the system to acquire memory blocks and ensure that they do not acquire memory directly from the OS. Depending on how the user of the BM pins and unpins pages, operators can ensure either that the memory blocks they acquire are safely spilled to disk and read back or always kept in memory (see below.)</p>
<p>Currently the BM has internal BufferPools to cache pages of 2 size: DEFAULT_PAGE_SIZE and LARGE_PAGE_SIZE, both of which are defined in <a class="el" href="configs_8h_source.html">configs.h</a>. We only have a mechanism to control the memory size of each <a class="el" href="classkuzu_1_1storage_1_1_buffer_pool.html">BufferPool</a>. So when the BM of the system is constructed, one pool of memory is allocated to cache files whose pages are of size DEFAULT_PAGE_SIZE, and a separate pool of memory is allocated to cache files whose pages are of size LARGE_PAGE_SIZE. Ideally we should move towards allocating a single pool of memory from which different size pages are allocated. The Umbra paper (<a href="http://db.in.tum.de/~freitag/papers/p29-neumann-cidr20.pdf">http://db.in.tum.de/~freitag/papers/p29-neumann-cidr20.pdf</a>) describes an mmap-based mechanism to do this (where the responsibility to handle memory fragmentation is delegated to the OS).</p>
<p>The BM uses CLOCK replacement policy to evict pages from frames, which is an approximate LRU policy that is based of FIFO-like operations.</p>
<p>All access to the BM is through a <a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a>. To use the BM to acquire in-memory blocks users can pin pages, which will then lead the BM to put these pages in memory, and then never unpin them and the BM will never spill those pages to disk. However <em>make sure to unpin these pages</em> eventually, otherwise this would be a form of internal memory leak. See InMemOverflowBuffer for an example, where this is done during the deconstruction of the InMemOverflowBuffer.</p>
<p>Users can also unpin their pages and then the BM might spill them to disk. The behavior of what is guaranteed to be kept in memory and what can be spilled to disk is directly determined by the pin/unpin calls of the users of BM.</p>
<p><a class="el" href="classkuzu_1_1storage_1_1_buffer_manager.html">BufferManager</a> supports a special pin function called pinWithoutReadingFromFile. A caller can call the common::page_idx_t newPageIdx = fh::addNewPage() function on the <a class="el" href="classkuzu_1_1storage_1_1_file_handle.html">FileHandle</a> fh they have, and then call bm::pinWithoutReadingFromFile(fh, newPageIdx), and the BM will not try to read this page from the file (because the page has not yet been written). </p>
</div><hr/>The documentation for this class was generated from the following files:<ul>
<li>src/include/storage/buffer_manager/<a class="el" href="buffer__manager_8h_source.html">buffer_manager.h</a></li>
<li>src/storage/buffer_manager/buffer_manager.cpp</li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
